<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Загрузка файлов | File Upload System</title>
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-cloud-upload-alt"></i> File Upload System</h1>
            <p>Безопасная загрузка файлов с сохранением в PostgreSQL</p>
        </header>

        <main class="main-content">
            <div class="upload-section">
                <form id="uploadForm" class="upload-form" action="/api/upload/upload" method="post" enctype="multipart/form-data">
                    <label class="file-label">
                        <input type="file" name="file" id="fileInput" class="file-input" required>
                        <span class="file-button">
                            <i class="fas fa-folder-open"></i> Выбрать файл
                        </span>
                        <span id="fileName" class="file-name">Файл не выбран</span>
                    </label>
                    
                    <button type="submit" class="submit-button">
                        <i class="fas fa-upload"></i> Загрузить файл
                    </button>
                </form>
            </div>

            <div id="message" class="message" style="display: none;"></div>
            
            <div id="fileInfo" class="file-info" style="display: none;">
                <h3><i class="fas fa-file-alt"></i> Информация о файле</h3>
                <div class="info-grid" id="infoGrid">
                    <!-- Динамически заполняется через JS -->
                </div>
            </div>

            <div class="supported-files">
                <p>Поддерживаемые форматы:</p>
                <div class="file-types">
                    <span class="file-type"><i class="fas fa-image"></i> JPEG</span>
                    <span class="file-type"><i class="fas fa-image"></i> PNG</span>
                    <span class="file-type"><i class="fas fa-image"></i> GIF</span>
                    <span class="file-type"><i class="fas fa-file-pdf"></i> PDF</span>
                </div>
                <p class="max-size">Максимальный размер: 5 MB</p>
            </div>
        </main>

        <footer class="footer">
            <p>© 2024 File Upload System | PostgreSQL + Node.js + Express</p>
        </footer>
    </div>

    <!-- JavaScript для интерактивности -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const fileName = document.getElementById('fileName');
            const uploadForm = document.getElementById('uploadForm');
            const messageDiv = document.getElementById('message');
            const fileInfoDiv = document.getElementById('fileInfo');
            const infoGrid = document.getElementById('infoGrid');
            
            // Отображение имени файла
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileName.textContent = this.files[0].name;
                } else {
                    fileName.textContent = 'Файл не выбран';
                }
            });
            
            // Обработка отправки формы
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const submitButton = this.querySelector('.submit-button');
                
                // Блокируем кнопку на время загрузки
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
                
                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showMessage('Файл успешно загружен!', 'success');
                        showFileInfo(result.file);
                    } else {
                        showMessage(result.error || 'Ошибка при загрузке файла', 'error');
                    }
                } catch (error) {
                    showMessage('Ошибка сети или сервера', 'error');
                    console.error('Error:', error);
                } finally {
                    // Разблокируем кнопку
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-upload"></i> Загрузить файл';
                    
                    // Сбрасываем форму
                    uploadForm.reset();
                    fileName.textContent = 'Файл не выбран';
                }
            });
            
            // Функция отображения сообщений
            function showMessage(text, type) {
                messageDiv.textContent = text;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
            
            // Функция отображения информации о файле
            function showFileInfo(file) {
                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleString('ru-RU');
                };
                
                const formatSize = (bytes) => {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };
                
                const infoItems = [
                    { label: 'Имя файла', value: file.originalName, icon: 'fa-file' },
                    { label: 'Системное имя', value: file.filename, icon: 'fa-hdd' },
                    { label: 'Размер', value: formatSize(file.size), icon: 'fa-weight' },
                    { label: 'Тип файла', value: file.mimetype, icon: 'fa-file-code' },
                    { label: 'Путь', value: file.path, icon: 'fa-folder' },
                    { label: 'Дата загрузки', value: formatDate(file.uploadedAt), icon: 'fa-calendar' }
                ];
                
                infoGrid.innerHTML = infoItems.map(item => `
                    <div class="info-item">
                        <span class="info-label"><i class="fas ${item.icon}"></i> ${item.label}:</span>
                        <span class="info-value">${item.value}</span>
                    </div>
                `).join('');
                
                fileInfoDiv.style.display = 'block';
            }
        });
    </script>
</body>
</html>